name: Notify All Dependabot Alerts to Slack

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'  

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Get Dependabot alerts
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN }}
      run: |
        curl -s -H "Authorization: token $GH_TOKEN" \
          -H "Accept: application/vnd.github+json" \
          https://api.github.com/repos/${{ github.repository }}/dependabot/alerts \
          -o alerts.json

    - name: Loop through all alerts and send Slack messages
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        jq -c '.[]' alerts.json | while read -r alert; do
          PACKAGE=$(echo "$alert" | jq -r '.dependency.package.name')
          SEVERITY=$(echo "$alert" | jq -r '.security_advisory.severity')
          SUMMARY=$(echo "$alert" | jq -r '.security_advisory.summary')
          URL=$(echo "$alert" | jq -r '.html_url')

          payload=$(jq -n --arg package "$PACKAGE" --arg severity "$SEVERITY" --arg summary "$SUMMARY" --arg url "$URL" '
            {
              "text": "ðŸš¨ New Dependabot Alert for \($package)",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸš¨ \($severity) Vulnerability in \($package)"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Summary:*\n\($summary)"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Alert"
                      },
                      "url": $url
                    }
                  ]
                }
              ]
            }')

          curl -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"
        done
